[toc]



# CPU

## 构成

-   运算器：负责算术运算和逻辑运算
-   控制器：负责控制程序运行的流程
-   寄存器：负责暂存CPU处理过程中的信息（数据、地址以及指令信息），访问速度最快
-   高速缓存：有CPU中的MMU控制，访问速度比内存快，低于寄存器



## 寄存器



寄存器分为两类：

-   用户可见寄存器：对所有程序可用
    -   数据（通用）寄存器：用于各种算术逻辑指令和访存指令
    -   地址寄存器：存储数据以及指令的物理地址
    -   条件码寄存器：保存CPU操作结果的各种标记位
-   控制和状态寄存器：操作系统可用
    -   程序计数器：记录下一条要执行的指令的地址
    -   指令寄存器：记录最近取出的地址
    -   程序状态字：记录了CPU运行模式的信息



## 指令执行的基本过程



![image-20200525225743342](https://images-1255831004.cos.ap-guangzhou.myqcloud.com/online/image-20200525225743342.png)

>   程序的执行就是由不断获取指令、执行指令周期组成



指令的类型：

-   访问存储器指令：负责CPU和存储器之间的数据传送
-   I/O指令：负责CPU和I/O模块之间的数据传送和命令发送
-   算术逻辑指令（数据处理指令）：执行关于数据的算术和逻辑操作
-   控制转移指令：指定一个新指令的执行起点
-   CPU控制指令：用于修改处理机状态



## 特权指令和非特权指令

>   如果某微型计算机是处于多用户或多任务的多道程序设计环境中，则它的指令系统中的指令必须分成两部分：特权指令和非特权指令。



特权指令：只能由操作系统执行

非特权指令：用户和操作系统都能执行

>   如果用户使用特权指令，一半会引起一次CPU状态切换



## CPU状态

>   多数系统将CPU工作状态划分为管态和目态



管态，又称特权态，具备交高的权限级别，可以执行全部指令，使用全部资源

目态，又称用户态，具有较低的权限级别

>   不同系统划分的状态不一定相同，不是所有系统都是管态和目态，有些系统会划分多个系统状态



## 程序状态字

>   为了解决处理机当前工作状态的问题，所有的处理机都有一些特殊寄存器，用以表明处理机当前的工作状态。



状态字包括：

-   CPU的工作状态代码：指令CPU目前处于管态还是目态
-   条件码：反应执行后的结果特征
-   中断屏蔽码：是否允许中断



# 存储系统

## 存储器类型

半导体存储器基本可以划分为两类：

-   读写型存储器（随机访问存储器，RAM）
-   只读型存储器（ROM）：能读数据，不能随意写数据（写数据使用特殊方法）

>   在微型计算机中，通常把一些常驻内存的模块以微程序形式固化在ROM中



## 存储器的层次结构

计算机存储系统的设计主要考虑3个问题：容量、速度和成本。



一般来说，3个目标不可能同时达到最优，要作权衡。存取速度越快，每比特价格越高；容量越大，每比特价格越低，同时存取速度也越慢。



一方面需要较低的比特价格和较大的容量，另一方面对计算机性能又有着高要求，这又需要价格昂贵、存储量相对较小但速度很快的存储器。解决的方案是采用层次化的存储体系结构。



![image-20200527081739104](https://images-1255831004.cos.ap-guangzhou.myqcloud.com/online/image-20200527081739104.png)

>   越接近顶端越贵，访问速度越快；越靠近底部越便宜，访问速度越慢



层次化的存储体系结构可以提高存储系统的效能，**关键点在于程序的存储访问局部性原理**

>   在较短时间内，CPU要执行的指令集合能比较稳定第保持在一个存储器的局部区域中，CPU也主要喝存储器的这个局部打交道



## 存储分块

存储的最小单位称为“二进制位”，它包含的信息为0或1。



存储器的最小编址单位是字节，1个字节包含8个二进制位。而两个字节称为1个字，4个字节称为1个双字。1024个字节称为1KB，1024KB称为1MB，1024MB称为1GB，1024GB称为1TB。



为了简化对存储器的分配和管理，在不少计算机系统中把存储器分成块。在为用户分配内存空间时，以块为最小单位，这样的块有时被称为一个物理页。而块的大小随计算机而异，512B、1KB、4KB、8KB的都有，也有其他大小的。



## 存储保护

常见的存储保护机制：

-   界地址寄存器（界限寄存器）
    通过一对寄存器表示用户程序在内存中可以访问内存地址的上限和下线，如果越界访问，则产生越界中断
-   存储键
    每个存储块都附加一个存储保护键。当一个用户程序被允许进入内存时，操作系统分给它一个唯一的不与其他程序相同的存储键号。并将分配给该程序的各存储块的存储键也设置成同样的键号。当操作系统挑选该程序上处理机运行时，操作系统同时将它的存储键号放入程序状态字（PSW）的存储键（“钥匙”）域中。每当处理机访问内存时，都将该内存块的存储键与PSW中的“钥匙”进行比较。如果相匹配，则允许访问；否则，拒绝并报警。



## 缓冲技术

缓冲技术一般有三种用途：

-   CPU和内存之间
-   CPU和其他外围设备之间
-   设备和设备之间的通信

>   缓冲技术是为了解决部件之间速度不匹配的问题



为了提高设备利用率，通常使用单个缓冲区是不够的。目前许多计算机系统广泛使用多缓冲区技术



## 中断技术

所谓中断，是指处理机对系统中或系统外发生的异步事件的响应。异步事件是指无一定时序关系的随机发生的事件，如外围设备完成数据传输，实时控制设备出现异常情况等。



中断的出现解决了主机和外围设备并行工作的问题，消除了因外围设备的慢速而使得主机等待的现象，提高了可靠性，为多机操作和实时处理提供了硬件基础。



引起中断的那些事件称为中断事件或中断源，中断源向处理机发出的请求信号称为中断请求，而处理中断事件的那段程序称为中断处理程序。



发生中断时正在执行的程序的暂停点称为中断断点，处理机暂停当前程序转而处理中断的过程称为中断响应，中断处理结束之后恢复原来程序的执行称为中断返回。



中断的作用：

-   提高CPU的使用率
-   提高系统的实时能力



典型中断：

-   程序中断
-   时钟中断
-   I/O中断
-   硬件失效中断



中断系统组成：

-   中断装置（硬件）：负责捕获、响应中断源，将CPU的控制权移交给中断处理程序
-   中断处理程序（软件）：辨别中断类型，并根据请求做出相应的操作



# 进程

为了能够并发执行程序，并对程序加以控制和描述，因而引入进程的概念



操作系统设置进程控制块的数据结构，其中存放了进程标识符、进程运行的当前状态、程序和数据的地址以及保存该程序运行时的CPU环境信息



程序段、数据段以及进程控制块，这三部分构成了一个进程的实体



## 定义

进程时具有独立功能的可并发执行的程序在一个数据集合上的运行过程，是操作系统进行资源分配和调度的独立单位



## 程序和进程的区别与联系

-   程序是进程运行的实体，进程是程序的一次执行
-   进程是操作系统资源分配和调度的一个独立单位
-   程序可以长期保存，进程是临时的，有生命周期的



## 基本状态及转换

-   就绪状态：进程已经得到了除CPU之外的资源，只要获得CPU，就可以立即执行
-   执行状态：进程已经获得CPU资源
-   阻塞状态：进程因为发生某种事件而暂停执行时的状态



![image-20200529110143018](https://images-1255831004.cos.ap-guangzhou.myqcloud.com/online/image-20200529110143018.png)



## 挂起状态

>   不少系统中，进程只有三种基本状态，但是在另一些系统中，基于某种需要又新增了一些新的进程状态，其中最重要的是挂起状态



![image-20200529110810446](https://images-1255831004.cos.ap-guangzhou.myqcloud.com/online/image-20200529110810446.png)



## 进程控制块

>   进程控制块记录了操作系统所需的、用于描述进程情况以及控制进程运行所需的全部信息



操作系统是根据PCB来对并发执行的进程进行控制和管理的。



系统是根据进程的PCB而感知到该进程的存在，进程控制块PCB是进程存在的唯一标志。



因为进程控制块PCB经常被系统访问，尤其是被运行频率很高的进程调度及分派程序访问，故PCB应常驻内存。



PCB中包括的信息：

1.  进程标识符信息：进程标识符用于唯一地标识一个进程
2.  CPU状态信息：由CPU中各种寄存器中的内容组成
    -   通用寄存器
    -   指令计数器
    -   程序状态字
    -   用户栈指针
3.  进程调度信息
4.  进程控制信息



>   操作系统内核：
>
>   ​	将一些与硬件紧密相关的模块，诸如中断处理程序、各种常用设备的驱动程序以及运行频率较高的模块，都安排在紧靠硬件的软件层次中，并使它们常驻内存，以便提高操作系统的运行效率，并对它们加以特殊保护



## 进程调度



三级调度：一个程序从提交直到完成，通常需要经历三级调度

1.  高级调度（作业调度）：决定将那些在外存上处于后备状态的作业调入主机内存，准备执行
2.  低级调度（进程调度）：决定就绪队列中那个进程将获得CPU资源，使操作系统中最基本的调度
3.  中级调度：在内存和外存对换区之间进行程序对换，以此解决内存紧张问题



进程调度方式：

1.  非剥夺方式：一旦将CPU分配给进程就一直让它运行下去，直到进程完成或进入阻塞状态时，才把CPU分配给另一个进程
2.  剥夺方式：系统可以基于某种原则剥夺分配给进程的CPU资源
    -   优先权原则
    -   短进程优先原则
    -   时间片原则



进程调度算法

1.  先进先出算法
    -   优点：实现简单，公平
    -   缺点：引起短进程不满
2.  最短CPU运行期优先调度算法
    从就绪队列中选出“下一个CPU执行期”最短的进程，为这个进程分配CPU资源
    -   优点：调度性能较好
    -   缺点：对于进程的预估CPU执行事件只能根据每个进程的历史来预测，不准确
3.  最高响应比优先调度算法
    非剥夺的调度算法，每个进程都有一个响应比，从就绪队列中挑选出响应比高的进程分配CPU资源

![image-20200529203825891](https://images-1255831004.cos.ap-guangzhou.myqcloud.com/online/image-20200529203825891.png)

>   -   等待时间相同，服务时间越短，越早分配CPU资源
>   -   服务时间相同，等待时间越长，越早分配CPU资源

4.  优先级调度算法
    从就绪队列中挑出优先级高的进程分配CPU资源
5.  时间片轮转调度算法
    常用在分时系统，按照先进先出原则轮流调度就绪队列中的进程

![image-20200529204258226](https://images-1255831004.cos.ap-guangzhou.myqcloud.com/online/image-20200529204258226.png)

6.  前后台调度算法
    用在批处理和分时结合的系统中
7.  多级反馈队列轮转算法

![image-20200529204604321](https://images-1255831004.cos.ap-guangzhou.myqcloud.com/online/image-20200529204604321.png)

>   弄几个就绪队列，优先级高的就绪队列多分配一些时间片



# 线程

>   20世纪80年代，人们提出比进程更小的能独立运行的基本单位 - 线程，试图通过它来提供系统内程序并发执行的效率，从而进一步提高系统的吞吐量
>
>   简单来说：进程的出现就是为了能并发，线程的出现是为了能用好并发



引入进程的目的是使多个程序并发执行以改善资源利用率及提高系统的吞吐量；那么，在操作系统中再引入线程，则是为了减少程序并发执行时所付出的时空开销，使操作系统具有更好的并发性。



由于进程是一个资源拥有者，因而在进程的创建、撤销和切换中，系统必须为之付出较大的时空开销。也正因如此，在系统中所设置的进程数目不宜过多，进程切换的频率也不宜过高，但这也就限制了并发程度的进一步提高。



对作为调度和分派的基本单位，不同时作为独立分配资源的单位，以使之轻装运行；而对拥有资源的基本单位，又不频繁地对之进行切换。正是在这种思想的指导下，产生了线程概念。



## 定义

线程是进程的一个实体，是被系统独立调度和分派的基本单位。



线程自己基本不拥有系统资源，只拥有一点运行中必不可少的资源（程序计数器、寄存器、栈等），但它可以与同属一个进程的其他线程共享进程所拥有的资源。



## 基本状态

-   就绪
-   阻塞
-   执行



## 好处

1.  线程创建销毁开销小
2.  线程之间的切换成本低
3.  （同一进程）线程之间互相通信无需调用内核，不需要额外的通信机制
4.  线程能独立执行，能充分利用和发挥处理及与外围设备并行工作的能力



## 类型

>   线程可以分为两类：内核支持线程和用户级线程



内核支持线程的创建、撤销和切换都由内核实现

用户级线程的创建、撤销和切换都不利用系统调用来实现，内核也并不知道由用户级线程的存在



用户级线程和内核支持线程比较；

-   用户级线程切换速度快
    用户级线程的切换通常是发生在一个应用进程的诸线程之间，这不仅无须通过中断进入操作系统的内核，而且切换的规则也远比进程调度和切换的规则简单。

-   内核支持线程进行系统调用方便
    如果系统中设置的是内核支持线程，则调度是以线程为单位，当一个线程调用一个系统调用时，内核把系统调用只看作该线程的行为，因而阻塞该线程，于是可以再调度该进程中的其他线程执行。

-   用户级线程调度以进程为单位；内核支持线程调度以线程为单位
        假如在进程A中包含了一个用户级线程，而在另一个进程B中含有100个线程，这样，进程A中线程的运行时间将是进程B中各线程运行时间的100倍

    ​    假如系统中设置的是内核支持线程，其调度是以线程为单位进行的，这样，进程B可以获得的处理机时间是进程A的100倍，进程B可使100个系统调用并发工作。